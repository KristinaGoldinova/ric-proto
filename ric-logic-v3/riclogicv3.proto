syntax = "proto3";

package ric.logic.v3;

option go_package = "riclogicv3";

service RicLogicV3 {
  rpc StartAutomaton(StartAutomatonRequest) returns (StartAutomatonResponse);
  rpc StopAutomaton(StopAutomatonRequest) returns (StopAutomatonResponse);
  
  rpc GetAutomatons(GetAutomatonsRequest) returns (GetAutomatonsResponse);
  rpc GetAutomatonsStream(GetAutomatonsRequest) returns (stream AutomatonInfo);

  rpc EmitEvent(EmitEventRequest) returns (EmitEventResponse);  
}

message AutomatonStats {
  int32 started = 1;
  int32 transitions = 2;
  int32 actions = 3;
  int32 packets = 4;
  int32 events = 5;
  string halted = 6;
}

message StartAutomatonRequest {
  string object_id = 1;
  string automaton_id = 2;
}

message StartAutomatonResponse {}

message GetAutomatonsRequest {
  string object_id = 1;
}

message GetAutomatonsResponse {
  repeated AutomatonInfo automatons = 1;
}

message EmitEventRequest {
  string object_id = 1;
  string automaton_id = 2;
  string event = 3;
  string payload = 4;
}

message EmitEventResponse {}

message AutomatonInfo {
  string object_id = 1;
  string automaton_id = 2;

  string status = 3;
  string state = 4;
  string transition = 5;

  AutomatonStats stats = 6;
  repeated LogEntry logs = 7;
}

message GetRuntimeInfoRequest {
  string object_id = 1;
  string automaton_id = 2;
}

message StopAutomatonRequest {
  string object_id = 1;
  string automaton_id = 2;
}

message StopAutomatonResponse {}

message LogEventContext {
  string group_id = 1;
  string user_id = 2;
  string span_id = 3;
}

message LogEntry {
  string id = 1;
  int32 ts = 2;

  string object_id = 3;
  string automaton_id = 4;
  
  string instance = 5;
  string category = 6;
  string message = 7;

  string event = 8;
  string state = 9;
  string transition = 10;

  LogEventContext ctx = 11;
}
